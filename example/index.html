<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.5, maximum-scale=1.5, user-scalable=no"/>
    <script src="jquery.js"></script>
    <script src="cncserver.client.api.js"></script>
    <script src="cncserver.client.commander.js"></script>
    <style type="text/css">
      body {
        font-family: sans-serif;
      }
    </style>
  </head>
  <title>CNC Server Controller</title>
<body>
  <h3>CNC Server example Controller</h3>
  <fieldset><legend>General</legend>
    <button id="unlock">Unlock</button>
    <button id="zero">Zero</button>
  </fieldset>

  <fieldset><legend>X,Y Movement</legend>
    <button id="park">PARK</button>
    <table>
      <tr>
        <td><button class="move">0,0</button></td>
        <td><button class="move">25,0</button></td>
        <td><button class="move">50,0</button></td>
        <td><button class="move">75,0</button></td>
        <td><button class="move">100,0</button></td>
      </tr>
      <tr>
        <td><button class="move">0,25</button></td>
        <td><button class="move">25,25</button></td>
        <td><button class="move">50,25</button></td>
        <td><button class="move">75,25</button></td>
        <td><button class="move">100,25</button></td>
      </tr>
      <tr>
        <td><button class="move">0,50</button></td>
        <td><button class="move">25,50</button></td>
        <td><button class="move">50,50</button></td>
        <td><button class="move">75,50</button></td>
        <td><button class="move">100,50</button></td>
      </tr>
      <tr>
        <td><button class="move">0,75</button></td>
        <td><button class="move">25,75</button></td>
        <td><button class="move">50,75</button></td>
        <td><button class="move">75,75</button></td>
        <td><button class="move">100,75</button></td>
      </tr>
      <tr>
        <td><button class="move">0,100</button></td>
        <td><button class="move">25,100</button></td>
        <td><button class="move">50,100</button></td>
        <td><button class="move">75,100</button></td>
        <td><button class="move">100,100</button></td>
      </tr>
    </table>
  </fieldset>

  <fieldset><legend>Z/Servo Control</legend>
    <button id="up">Up</button>
    <button id="draw">Draw</button>
  </fieldset>

  <fieldset id="tools"><legend>Available Tools</legend>
    <h4>Loading tool set...</h4>
  </fieldset>

  <fieldset><legend>Composite Functions</legend>
    <button id="diagtest">Run Diag Test</button>
  </fieldset>

<script>
  var runningTest = false;

  // Initialize CNC Server connection details
  // (thanks to CORS support, this should be fully portable)
  cncserver.api.server = {
    domain: document.domain,
    port: location.port ? location.port : 80,
    protocol: 'http',
    version: '1'
  };

  var run = cncserver.cmd.run; // Shortcut!

  // Bind button action click
  $('button').click(function(){
    var id = this.id;
    switch(id) {
      case 'diagtest':
        runningTest = !runningTest;
        if (!runningTest) {
          $(this).text('Run Diag Test');
          cncserver.cmd.clear();
          run('park');
        } else {
          $(this).text('STOP Diag Test');
          runTest();
        }

        break;
      case 'unlock':
        cncserver.api.motors.unlock();
        break;
      case 'zero':
        cncserver.api.pen.zero();
        break;
      case 'park':
        //cncserver.api.pen.park(); // << Direct method
        run('park');                // << Queue method
        break;
      case 'up':
      case 'draw':
        cncserver.api.pen.height(id);
        break;
    }

    // One of the move button array
    if ($(this).is('.move')) {
      var pos = $(this).text().split(',');
      cncserver.api.pen.move({x: pos[0], y: pos[1]});
    }
  });

  // Populate tool buttons
  cncserver.api.tools.list(function(data){
    if (data) {
      $('#tools h4').remove();
      for (var i in data.tools) {
        $('<button>').text(data.tools[i]).appendTo('#tools');
      }
      $('#tools button').click(function(){
        run('tool', $(this).text());
      });
    } else {
      $('#tools h4').text('Failed to load tools :(');
    }
  });

  // Test runner function
  function runTest(){
    run('move', {x:75,y:75});
    run('move', {x:65,y:0});
    run('move', {x:75,y:100});
    run('move', {x:100,y:0});
    run('move', {x:0,y:100});
    run('move', {x:0,y:0});
    run('move', {x:100,y:100});
    run('park');
    run('custom', runTest);
  }

</script>


</body>
</html>

